# 💾 第三章：备份与恢复

> 留住每一刻，随时能回到过去

---

## 3.1 为什么需要备份？

### 真实场景

【信息框 - 黄色】
⚠️ **以下情况你遇到过吗？**

- 🤔 "我改了一堆配置，现在想回到之前的状态..."
- 😱 "系统崩了，我的 OpenClaw 配置全没了！"
- 💻 "换电脑了，想把配置迁移过去..."
- 🧪 "想试试新功能，但怕把现在的配置搞坏..."

**备份虾 (ocs) 就是为解决这些问题而生！**

### 备份的价值

【表格】
| 场景 | 没有备份 | 有备份 |
|------|----------|--------|
| 配置出错 | 重装 + 重新配置（2小时） | 恢复快照（2分钟） |
| 换机器 | 从零开始 | 导入快照，一键恢复 |
| 系统重装 | 丢失所有配置 | 完全恢复 |
| 多人协作 | 配置不一致 | 共享快照 |

---

## 3.2 快照类型

虾族生态支持四种快照类型：

【信息框 - 详细说明】

### 🌱 纯净安装 (fresh)
**什么时候用：** 刚完成 OpenClaw 安装和初始配置

**包含：** 基础配置，没有历史数据

**用途：** 作为"干净"的基准点

```bash
ocs fresh
# 或
ocs create
# 然后选择类型：纯净安装
```

### 🏠 当前状态 (current)
**什么时候用：** 日常备份

**包含：** 完整配置 + 所有数据 + 历史记录

**用途：** 保留某个时间点的完整状态

```bash
ocs create
# 选择类型：当前状态
```

### ⚙️ 自定义 (custom)
**什么时候用：** 特殊用途备份

**用途：** 手动标记的特定状态

### 🤖 自动备份 (auto)
**什么时候用：** 系统自动创建

**场景：** 卸载前、升级前自动备份

---

## 3.3 创建你的第一个快照

### 3.3.1 交互式创建

【代码块 - bash】
```bash
ocs create
```

你会看到：

【代码块 - text】
```
    💾 ╔═══════════════════════════════════════╗
      ║     OpenClaw Snapshot                 ║
      ║        备份虾 - 留住每一刻            ║
      ╚═══════════════════════════════════════╝

📸 创建新快照

快照名称 (如: fresh_install): my_backup
描述 (可选): 2025年春节前的配置

快照类型:
1. 🌱 纯净安装 (刚装好的状态)
2. 🏠 当前状态 (包含所有配置)
3. ⚙️  自定义

选择 (1/2/3): 2

🦐 正在努力... 🦞 加油加载...

✅ 快照创建成功!
  📛 名称: my_backup
  🆔 ID: my_backup_20250115_143022
  📅 时间: 2025-01-15T14:30:22
  💾 大小: 12.5 MB
  🔖 校验: a1b2c3d4
```

### 3.3.2 快速创建纯净快照

如果你只是想快速保存当前纯净状态：

【代码块 - bash】
```bash
ocs fresh
```

这会自动使用：
- 名称：`fresh_install`
- 类型：🌱 纯净安装

---

## 3.4 管理快照

### 3.4.1 查看所有快照

【代码块 - bash】
```bash
ocs list
```

输出示例：

【代码块 - text】
```
📋 快照列表 (5 个)

ID                           名称                类型      大小      时间
--------------------------   ----------------   -------   -------   -------------------
fresh_install_20250110...    fresh_install      🌱 fresh  8.2 MB   2025-01-10 09:00:00
weekly_20250112_020000       weekly_20250112    🏠 current 12.1 MB  2025-01-12 02:00:00
before_experiment_20250113   before_experiment  ⚙️ custom  15.3 MB  2025-01-13 15:30:00
pre_upgrade_20250114         pre_upgrade        🤖 auto    14.8 MB  2025-01-14 10:00:00
weekly_20250115_020000       weekly_20250115    🏠 current 16.2 MB  2025-01-15 02:00:00
```

### 3.4.2 删除快照

【代码块 - bash】
```bash
ocs delete <快照ID>
```

例如：
```bash
ocs delete weekly_20250112_020000
```

【信息框 - 红色】
❗ 删除后无法恢复！建议保留最近的 3-5 个快照

---

## 3.5 恢复配置

### 3.5.1 恢复到指定快照

【代码块 - bash】
```bash
ocs restore <快照ID>
```

完整流程：

【折叠块：详细步骤】
1. **查看可用快照**
   ```bash
   ocs list
   ```

2. **选择要恢复的快照**
   ```bash
   ocs restore fresh_install_20250110_090000
   ```

3. **确认恢复**
   ```
   ⚠️  这将覆盖当前的 OpenClaw 配置！
   当前配置将自动备份
   
   确认恢复? 输入 'RESTORE' 继续: RESTORE
   ```

4. **重启服务**
   ```bash
   openclaw gateway restart
   ```

### 3.5.2 恢复注意事项

【信息框 - 黄色】
⚠️ **恢复前须知：**

1. 当前配置会自动备份（以防万一）
2. 恢复会停止 OpenClaw 服务
3. 恢复后需要重启服务
4. 部分运行时数据可能丢失（如当前对话）

---

## 3.6 跨机器迁移

### 3.6.1 导出快照

在旧机器上：

【代码块 - bash】
```bash
# 导出快照
ocs export my_config

# 或指定路径
ocs export my_config --output ~/Desktop/
```

会生成：`~/Desktop/my_config_20250115_143022.tar.gz`

### 3.6.2 传输到新机器

【折叠块：多种传输方式】
**方式1: scp（推荐）**
```bash
scp ~/Desktop/my_config_xxx.tar.gz user@new-machine:~/
```

**方式2: 云盘**
上传到百度网盘 / iCloud / Dropbox，新机器下载

**方式3: U盘**
拷贝到 U 盘，插到新机器

### 3.6.3 新机器导入

在新机器上：

【代码块 - bash】
```bash
# 1. 安装 OpenClaw 基础环境
# （见第二章）

# 2. 安装快照工具
pip install openclaw-snapshot

# 3. 导入快照
ocs import ~/my_config_xxx.tar.gz

# 4. 查看导入的快照
ocs list

# 5. 恢复
ocs restore my_config_xxx

# 6. 重启服务
openclaw gateway restart
```

【信息框 - 绿色】
✅ 完成！配置已迁移到新机器

---

## 3.7 备份策略建议

### 推荐策略

【信息框 - 蓝色】
📌 **黄金法则：3-2-1 备份策略**

- **3** 份副本：原始 + 2 份备份
- **2** 种媒介：本地 + 云端/U盘
- **1** 份异地：不同物理位置

### 实际操作建议

【表格】
| 时机 | 操作 | 保留数量 |
|------|------|----------|
| 部署完成后 | ocs fresh | 永久保留 |
| 每周 | ocs create | 最近4周 |
| 重要变更前 | ocs create | 最近3次 |
| 升级前 | 自动备份 | 直到确认升级成功 |

### 自动化备份

添加到 crontab（Linux/macOS）：

【代码块 - bash】
```bash
# 编辑 crontab
crontab -e

# 添加每周日凌晨2点自动备份
0 2 * * 0 /usr/local/bin/ocs create <<< "weekly_$(date +\%Y\%m\%d)"
```

---

## 3.8 故障排查

### Q: 快照创建失败？

【折叠块：排查步骤】
```bash
# 检查磁盘空间
df -h

# 检查权限
ls -la ~/.openclaw

# 手动创建测试
touch ~/.openclaw/test.txt
```

### Q: 快照文件太大？

【折叠块：优化建议】
```bash
# 清理日志
rm -rf ~/.openclaw/logs/*

# 清理媒体文件
rm -rf ~/.openclaw/media/*

# 重新创建快照
ocs create
```

### Q: 恢复后配置不生效？

【折叠块：解决步骤】
```bash
# 1. 确认服务已停止
pkill -f openclaw

# 2. 检查恢复的文件
ls -la ~/.openclaw/

# 3. 重启服务
openclaw gateway restart

# 4. 查看日志
openclaw gateway logs
```

---

## 3.9 下一步

【按钮】
→ [第四章：卸载与重装](链接)

备份做好了？现在学习如何安全卸载：
- 卸载前自动快照
- 重装后恢复
- 完整重装案例

---

*第三章完*

📊 **本章统计**
- 预计阅读时间：12分钟
- 预计操作时间：10分钟
- 难度：⭐（简单）

💡 **关键记住：**
- 部署后立即 `ocs fresh`
- 每周 `ocs create`
- 重要操作前 `ocs create`
